{{/*
Standard Kubernetes Ingress with optional nginx annotations
Usage: {{ include "common.ingress.standalone" . }}
*/}}
{{- define "common.ingress.standalone" -}}
{{- include "common.withMergedValues" (dict "templateName" "common.ingress" "context" .) -}}
{{- end -}}

{{- define "common.ingress" -}}
{{- $ingressEnabled := .Values.ingress.enabled | default true -}}
{{- if $ingressEnabled }}
{{- /* Ingress defaults */}}
{{- $className := .Values.ingress.className | default "nginx" -}}
{{- $servicePort := .Values.service.port | default 80 -}}
{{- $proxyBodySize := .Values.ingress.proxyBodySize | default "200m" -}}
{{- $timeout := .Values.ingress.timeout | default "3600" -}}
{{- $keepAlive := .Values.ingress.keepAlive | default "3600" -}}
{{- /* Rate limiting defaults - permissive values to catch abuse without affecting heavy users */}}
{{- $rateLimitDefaults := dict "enabled" true "rpm" 600 "rps" 30 "connections" 50 "burstMultiplier" 10 "whitelist" "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" -}}
{{- $rateLimit := merge (.Values.ingress.rateLimit | default dict) $rateLimitDefaults -}}
{{- /* Security headers defaults */}}
{{- $securityHeadersDefaults := dict "enabled" true "hsts" "max-age=31536000; includeSubDomains; preload" "frameOptions" "SAMEORIGIN" "contentTypeOptions" "nosniff" "xssProtection" "1; mode=block" "referrerPolicy" "strict-origin-when-cross-origin" "permissionsPolicy" "geolocation=(), microphone=(), camera=()" "contentSecurityPolicy" "" -}}
{{- $securityHeaders := merge (.Values.ingress.securityHeaders | default dict) $securityHeadersDefaults -}}
{{- /* SSL redirect defaults */}}
{{- $forceSSLRedirect := .Values.ingress.forceSSLRedirect | default true -}}
{{- $sslRedirect := .Values.ingress.sslRedirect | default true -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Chart.Name }}
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: {{ .Values.ingress.clusterIssuer | default "letsencrypt-http" | quote }}
    {{- if ne .Values.ingress.externalDns false }}
    {{- if .Values.ingress.externalDnsWildcard }}
    external-dns.alpha.kubernetes.io/hostname: {{ printf "%s,*.%s" .Values.ingress.host .Values.ingress.host | quote }}
    {{- else }}
    external-dns.alpha.kubernetes.io/hostname: {{ .Values.ingress.host | quote }}
    {{- end }}
    {{- end }}
    nginx.ingress.kubernetes.io/proxy-body-size: {{ $proxyBodySize | quote }}
    nginx.ingress.kubernetes.io/proxy-connect-timeout: {{ $timeout | quote }}
    nginx.ingress.kubernetes.io/proxy-send-timeout: {{ $timeout | quote }}
    nginx.ingress.kubernetes.io/proxy-read-timeout: {{ $timeout | quote }}
    nginx.ingress.kubernetes.io/keep-alive: {{ $keepAlive | quote }}
    {{- /* Rate limiting annotations */}}
    {{- if $rateLimit.enabled }}
    nginx.ingress.kubernetes.io/limit-rpm: {{ $rateLimit.rpm | quote }}
    nginx.ingress.kubernetes.io/limit-rps: {{ $rateLimit.rps | quote }}
    nginx.ingress.kubernetes.io/limit-connections: {{ $rateLimit.connections | quote }}
    nginx.ingress.kubernetes.io/limit-burst-multiplier: {{ $rateLimit.burstMultiplier | quote }}
    nginx.ingress.kubernetes.io/limit-whitelist: {{ $rateLimit.whitelist | quote }}
    {{- end }}
    {{- /* Security headers via configuration-snippet */}}
    {{- if $securityHeaders.enabled }}
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "Strict-Transport-Security: {{ $securityHeaders.hsts }}";
      more_set_headers "X-Frame-Options: {{ $securityHeaders.frameOptions }}";
      more_set_headers "X-Content-Type-Options: {{ $securityHeaders.contentTypeOptions }}";
      more_set_headers "X-XSS-Protection: {{ $securityHeaders.xssProtection }}";
      more_set_headers "Referrer-Policy: {{ $securityHeaders.referrerPolicy }}";
      more_set_headers "Permissions-Policy: {{ $securityHeaders.permissionsPolicy }}";
      {{- if $securityHeaders.contentSecurityPolicy }}
      more_set_headers "Content-Security-Policy: {{ $securityHeaders.contentSecurityPolicy }}";
      {{- end }}
    {{- end }}
    {{- /* Force SSL redirect */}}
    {{- if $forceSSLRedirect }}
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    {{- end }}
    {{- if $sslRedirect }}
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    {{- end }}
spec:
  ingressClassName: {{ $className }}
  tls:
    - hosts:
        - {{ .Values.ingress.host }}
      secretName: {{ .Chart.Name }}-tls
  rules:
    - host: {{ .Values.ingress.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ .Chart.Name }}
                port:
                  number: {{ $servicePort }}
{{- end }}
{{- end -}}
