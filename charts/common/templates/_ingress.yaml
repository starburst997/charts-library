{{/*
Standard Kubernetes Ingress with optional nginx annotations
Usage: {{ include "common.ingress.standalone" . }}
*/}}
{{- define "common.ingress.standalone" -}}
{{- include "common.withMergedValues" (dict "templateName" "common.ingress" "context" .) -}}
{{- end -}}

{{- define "common.ingress" -}}
{{- $ingressEnabled := .Values.ingress.enabled | default true -}}
{{- if $ingressEnabled }}
{{- /* Ingress defaults */}}
{{- $className := .Values.ingress.className | default "nginx" -}}
{{- $servicePort := .Values.service.port | default 80 -}}
{{- $proxyBodySize := .Values.ingress.proxyBodySize | default "200m" -}}
{{- $timeout := .Values.ingress.timeout | default "3600" -}}
{{- $keepAlive := .Values.ingress.keepAlive | default "3600" -}}
{{- /* Rate limiting defaults - permissive values to catch abuse without affecting heavy users */}}
{{- $rateLimitDefaults := dict
    "enabled" true
    "rpm" 600
    "rps" 30
    "connections" 50
    "burstMultiplier" 10
    "whitelist" "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
-}}
{{- $rateLimit := merge (.Values.ingress.rateLimit | default dict) $rateLimitDefaults -}}
{{- /* Headers enabled check (defaults handled in _headers.yaml ConfigMap) */}}
{{- $headersEnabled := (.Values.ingress.headers).enabled | default true -}}
{{- /* SSL redirect defaults */}}
{{- $forceSSLRedirect := .Values.ingress.forceSSLRedirect | default true -}}
{{- $sslRedirect := .Values.ingress.sslRedirect | default true -}}
{{- /* WWW redirect defaults - these create separate ingress resources */}}
{{- $forceWWW := .Values.ingress.forceWWW | default false -}}
{{- $forceNonWWW := .Values.ingress.forceNonWWW | default false -}}
{{- /* Determine hosts for www handling */}}
{{- $host := .Values.ingress.host -}}
{{- $hostHasWWW := hasPrefix "www." $host -}}
{{- $wwwHost := ternary $host (printf "www.%s" $host) $hostHasWWW -}}
{{- $nonWWWHost := ternary (trimPrefix "www." $host) $host $hostHasWWW -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Chart.Name }}
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: {{ .Values.ingress.clusterIssuer | default "letsencrypt-http" | quote }}
    {{- if ne .Values.ingress.externalDns false }}
    {{- if .Values.ingress.externalDnsWildcard }}
    external-dns.alpha.kubernetes.io/hostname: {{ printf "%s,*.%s" .Values.ingress.host .Values.ingress.host | quote }}
    {{- else }}
    external-dns.alpha.kubernetes.io/hostname: {{ .Values.ingress.host | quote }}
    {{- end }}
    {{- end }}
    nginx.ingress.kubernetes.io/proxy-body-size: {{ $proxyBodySize | quote }}
    nginx.ingress.kubernetes.io/proxy-connect-timeout: {{ $timeout | quote }}
    nginx.ingress.kubernetes.io/proxy-send-timeout: {{ $timeout | quote }}
    nginx.ingress.kubernetes.io/proxy-read-timeout: {{ $timeout | quote }}
    nginx.ingress.kubernetes.io/keep-alive: {{ $keepAlive | quote }}
    {{- /* Rate limiting annotations */}}
    {{- if $rateLimit.enabled }}
    nginx.ingress.kubernetes.io/limit-rpm: {{ $rateLimit.rpm | quote }}
    nginx.ingress.kubernetes.io/limit-rps: {{ $rateLimit.rps | quote }}
    nginx.ingress.kubernetes.io/limit-connections: {{ $rateLimit.connections | quote }}
    nginx.ingress.kubernetes.io/limit-burst-multiplier: {{ $rateLimit.burstMultiplier | quote }}
    nginx.ingress.kubernetes.io/limit-whitelist: {{ $rateLimit.whitelist | quote }}
    {{- end }}
    {{- /* Headers via ConfigMap reference */}}
    {{- if $headersEnabled }}
    nginx.ingress.kubernetes.io/custom-headers: {{ .Values.namespace }}/{{ .Chart.Name }}-headers
    {{- end }}
    {{- /* Force SSL redirect */}}
    {{- if $forceSSLRedirect }}
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    {{- end }}
    {{- if $sslRedirect }}
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    {{- end }}
spec:
  ingressClassName: {{ $className }}
  tls:
    - hosts:
        {{- if $forceWWW }}
        - {{ $wwwHost }}
        {{- else if $forceNonWWW }}
        - {{ $nonWWWHost }}
        {{- else }}
        - {{ $host }}
        {{- end }}
      secretName: {{ .Chart.Name }}-tls
  rules:
    {{- if $forceWWW }}
    - host: {{ $wwwHost }}
    {{- else if $forceNonWWW }}
    - host: {{ $nonWWWHost }}
    {{- else }}
    - host: {{ $host }}
    {{- end }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ .Chart.Name }}
                port:
                  number: {{ $servicePort }}
{{- /* Redirect ingress for forceWWW: redirects non-www to www */}}
{{- if $forceWWW }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Chart.Name }}-redirect
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: {{ .Values.ingress.clusterIssuer | default "letsencrypt-http" | quote }}
    {{- if ne .Values.ingress.externalDns false }}
    external-dns.alpha.kubernetes.io/hostname: {{ $nonWWWHost | quote }}
    {{- end }}
    nginx.ingress.kubernetes.io/server-snippet: |
      return 301 https://{{ $wwwHost }}$request_uri;
    {{- if $forceSSLRedirect }}
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    {{- end }}
    {{- if $rateLimit.enabled }}
    nginx.ingress.kubernetes.io/limit-rpm: {{ $rateLimit.rpm | quote }}
    nginx.ingress.kubernetes.io/limit-rps: {{ $rateLimit.rps | quote }}
    nginx.ingress.kubernetes.io/limit-connections: {{ $rateLimit.connections | quote }}
    nginx.ingress.kubernetes.io/limit-burst-multiplier: {{ $rateLimit.burstMultiplier | quote }}
    nginx.ingress.kubernetes.io/limit-whitelist: {{ $rateLimit.whitelist | quote }}
    {{- end }}
spec:
  ingressClassName: {{ $className }}
  tls:
    - hosts:
        - {{ $nonWWWHost }}
      secretName: {{ .Chart.Name }}-redirect-tls
  rules:
    - host: {{ $nonWWWHost }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ .Chart.Name }}
                port:
                  number: {{ $servicePort }}
{{- end }}
{{- /* Redirect ingress for forceNonWWW: redirects www to non-www */}}
{{- if $forceNonWWW }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Chart.Name }}-redirect
  namespace: {{ .Values.namespace }}
  annotations:
    cert-manager.io/cluster-issuer: {{ .Values.ingress.clusterIssuer | default "letsencrypt-http" | quote }}
    {{- if ne .Values.ingress.externalDns false }}
    external-dns.alpha.kubernetes.io/hostname: {{ $wwwHost | quote }}
    {{- end }}
    nginx.ingress.kubernetes.io/server-snippet: |
      return 301 https://{{ $nonWWWHost }}$request_uri;
    {{- if $forceSSLRedirect }}
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    {{- end }}
    {{- if $rateLimit.enabled }}
    nginx.ingress.kubernetes.io/limit-rpm: {{ $rateLimit.rpm | quote }}
    nginx.ingress.kubernetes.io/limit-rps: {{ $rateLimit.rps | quote }}
    nginx.ingress.kubernetes.io/limit-connections: {{ $rateLimit.connections | quote }}
    nginx.ingress.kubernetes.io/limit-burst-multiplier: {{ $rateLimit.burstMultiplier | quote }}
    nginx.ingress.kubernetes.io/limit-whitelist: {{ $rateLimit.whitelist | quote }}
    {{- end }}
spec:
  ingressClassName: {{ $className }}
  tls:
    - hosts:
        - {{ $wwwHost }}
      secretName: {{ .Chart.Name }}-redirect-tls
  rules:
    - host: {{ $wwwHost }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ .Chart.Name }}
                port:
                  number: {{ $servicePort }}
{{- end }}
{{- end }}
{{- end -}}
